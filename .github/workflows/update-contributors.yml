name: Update Contributors Data

on:
  schedule:
    # Runs once a day at 6:00 AM UTC
    # Change to '0 0 * * 0' for weekly (Sunday at midnight)
    # Change to '0 */6 * * *' for every 6 hours
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual triggering
  
jobs:
  update-contributors:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Fetch contributors data
      run: |
        echo "Fetching contributors from GitHub API..."
        
        # Create public directory if it doesn't exist
        mkdir -p public
        
        # Fetch contributors data into a temporary file
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             "https://api.github.com/repos/vatsal-bhakodia/smriti-ai/contributors" \
             > /tmp/contributors_temp.json
             
        # Check if the API call was successful
        if [ $? -ne 0 ]; then
          echo "Failed to fetch contributors data"
          exit 1
        fi
        
        # Verify the response is valid JSON and not an error
        if ! jq empty /tmp/contributors_temp.json 2>/dev/null; then
          echo "Invalid JSON response"
          cat /tmp/contributors_temp.json
          exit 1
        fi
        
        # Check if it's an error response
        if jq -e '.message' /tmp/contributors_temp.json > /dev/null 2>&1; then
          echo "GitHub API error:"
          cat /tmp/contributors_temp.json
          exit 1
        fi
        
        echo "Successfully fetched contributors data"
        
        # Create a single JSON file with both contributors and lastUpdated
        jq -n \
          --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")" \
          --slurpfile contributors /tmp/contributors_temp.json \
          '{lastUpdated: $timestamp, contributors: $contributors[0]}' \
          > public/contributors.json
        
        echo "Created combined contributors.json with timestamp"
        
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet public/contributors.json; then
          echo "No changes detected"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/contributors.json
        git commit -m "Update contributors data - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        git push
        
    - name: Summary
      run: |
        echo "Contributors update completed!"
        echo "Total contributors: $(jq '.contributors | length' public/contributors.json)"
        echo "Last updated: $(jq -r '.lastUpdated' public/contributors.json)"